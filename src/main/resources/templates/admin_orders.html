<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 주문 목록 (Dynamic) - Java Cafe</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
</head>

<body>

<script th:inline="javascript">
    let storeName = /*[[${session.admin != null ? session.admin.storeName : ''}]]*/ '';
</script>

<th:block th:replace="~{./include/adminBaseLayout :: setContent( ~{:: .wrap} ) }">

    <div class="wrap">
        <div class="notification-icon" id="notification-trigger">
            <div class="notification-popup" id="notification-popup">
                <div class="popup-arrow"></div> <p>주문내역이 없습니다.</p>
            </div>
        </div>

        <main class="main-content">
            <h2 class="main-title">주문 목록</h2>

            <div class="order-grid" id="order-grid-container">
            </div>
        </main>
    </div>
</th:block>

<footer class="footer-nav">
    <a href="/admin/menu" class="footer-nav-item active">메뉴 관리</a>
    <a href="/admin/orders" class="footer-nav-item">주문 관리</a>
    <a href="/admin/revenue" class="footer-nav-item">매출 관리</a>

    <a th:if="${isLoggedIn}" href="/admin/logout" class="footer-nav-item">로그아웃</a>
    <a th:unless="${isLoggedIn}" href="/admin/login" class="footer-nav-item">로그인</a>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 상수 및 변수 정의 ---

        const API_BASE_URL = '/api/orders';
        const API_ENDPOINT_LIST = `${API_BASE_URL}/admin-list?storeName=${storeName}`;
        const API_ENDPOINT_STATUS_UPDATE = `${API_BASE_URL}/status`;

        const POLLING_INTERVAL = 3000;
        let pollingTimer = null;

        const orderGrid = document.getElementById('order-grid-container');
        const notificationTrigger = document.getElementById('notification-trigger');
        const notificationPopup = document.getElementById('notification-popup');


        // API에서 주문 데이터를 가져와 화면에 렌더링
        async function fetchAndRenderOrders() {
            try {
                const response = await fetch(API_ENDPOINT_LIST, { cache: 'no-store' });

                if (!response.ok) {
                    throw new Error(`[1] HTTP error! status: ${response.status}`);
                }

                const orders = await response.json();
                renderOrders(orders);

            } catch (error) {
                console.error('주문 목록을 가져오는 데 실패했습니다:', error);
                orderGrid.innerHTML = `<div class="order-grid-empty">주문 목록 로딩 오류. (${error.message})</div>`;
            }
        }

        function showMobileAlert(message) {
            alert(message);
        }

        // 주문 배열을 받아 화면에 렌더링
        function renderOrders(orders) {
            orderGrid.innerHTML = '';

            if (!orders || orders.length === 0) {
                orderGrid.innerHTML = '<div class="order-grid-empty">현재 접수된 주문이 없습니다.</div>';
            } else {
                orders.forEach(order => {
                    const cardHtml = createOrderCard(order);
                    orderGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
            }
        }


        // 주문 객체(order)를 받아 HTML 카드 문자열을 생성
        function createOrderCard(order) {
            // 1. 주문 유형(orderType)에 따른 CSS 클래스 결정
            let cardTypeClass = 'type-default';
            if (order.orderType === '매장') cardTypeClass = 'type-store';
            else if (order.orderType === '포장') cardTypeClass = 'type-takeout';
            else if (order.orderType === '배달') cardTypeClass = 'type-delivery';

            // 2. 주문 아이템 목록(orderItemList)을 <li> 태그로 변환 (옵션 정보 포함)
            const menuItemsHtml = (order.orderItemList && Array.isArray(order.orderItemList))
                ? order.orderItemList.map(item => {
                    // ⭐ 옵션 정보 문자열 생성
                    let options = [];

                    // 샷 추가 여부
                    if (item.shot > 0) {
                        options.push(`샷+${item.shot}`);
                    }
                    // 텀블러 사용 여부 (1 또는 true일 때)
                    if (item.tumbler === 1 || item.tumbler === true) {
                        options.push('텀블러');
                    }
                    // 온도 (ICE/HOT)
                    if (item.temp) {
                        options.push(`[${item.temp}]`);
                    }

                    const optionsStr = options.length > 0
                        ? `<span class="item-options-detail" style="color:#a000a0; font-size:0.85em;">(${options.join(', ')})</span>`
                        : '';

                    return `
                <li>
                    <div class="menu-name-wrapper">
                        <span class="menu-name">${item.menuItemName || '알 수 없는 메뉴'}</span>
                        ${optionsStr} </div>
                    <span class="item-quantity">${item.quantity || 0}</span>
                </li>
            `;
                }).join('')
                : '';

            // 3. orderTime (DATETIME) 포맷팅
            let formattedTime = '00:00';
            if (order.orderTime) {
                try {
                    const date = new Date(order.orderTime);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    formattedTime = `${hours}시 ${minutes}분`;
                } catch (e) {
                    console.error("시간 포맷팅 오류", e);
                    formattedTime = "시간오류";
                }
            }

            // 4. 일일 번호 포맷팅
            const formattedDailyId = `#${String(order.dailyOrderNum || 0).padStart(4, '0')}`;

            // 5. 카드 템플릿
            return `
        <div class="order-card ${cardTypeClass}" id="order-card-${order.orderId}">
            <div>
                <div class="card-header">
                    <span class="order-id">${formattedDailyId}</span>
                    <span class="order-time">${formattedTime}</span>
                    <button class="card-menu-button" data-order-id="${order.orderId}">⋮</button>
                </div>

                <div class="user-info-row">
                    <span class="user-label">주문자:</span>
                    <span class="user-name" style="font-weight: 600;">${order.username || order.uId || '비회원'}</span>
                </div>

                <ul class="menu-list">
                    ${menuItemsHtml}
                </ul>
            </div>
            <div>
                <div class="card-footer-row">
                    <span>총 수량</span>
                    <span>${order.totalQuantity || 0}</span>
                </div>
                <div class="card-footer-total">
                    <span>${order.orderType || '알 수 없음'}</span>
                    <span>${(order.totalPrice || 0).toLocaleString('ko-KR')}원</span>
                </div>
            </div>

            <div class="card-menu-dropdown" id="menu-dropdown-${order.orderId}">
                <button class="complete" data-status="주문완료">✔ 완료</button>
                <button class="cancel" data-status="주문취소">✖ 취소</button>
            </div>
        </div>`;
        }

        /**
         * 주문 상태 업데이트 (완료/취소)
         */
        async function handleUpdateStatus(orderId, status) {

            // ⭐ [CRITICAL] orderId가 숫자로 확실히 변환되도록 합니다.
            const parsedOrderId = parseInt(orderId);
            if (isNaN(parsedOrderId)) {
                console.error("유효하지 않은 Order ID:", orderId);
                showMobileAlert('유효하지 않은 주문 ID입니다.');
                return;
            }

            // (pollingTimer 관련 코드는 생략하고, 로직에만 집중합니다.)
            // clearInterval(pollingTimer);

            try {
                // API 경로: /api/orders/status/{orderId}
                const response = await fetch(`${API_ENDPOINT_STATUS_UPDATE}/${parsedOrderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    // ⭐ 서버가 기대하는 JSON 구조 { "status": "주문완료" }를 전송
                    body: JSON.stringify({ status: status })
                });

                if (response.status === 400) {
                    // 400 에러는 JSON 파싱 오류나 필수값 누락입니다.
                    // 서버가 JSON을 제대로 못 받았을 가능성이 높습니다.
                    throw new Error(`[3] 서버 응답 오류: ${response.status}`);
                }

                if (!response.ok) {
                    throw new Error(`[3] 서버 응답 오류: ${response.status}`);
                }

                // DB에서 확인된 최신 목록으로 새로고침
                await fetchAndRenderOrders();
                showMobileAlert('상태 변경 완료.');

            } catch (error) {
                console.error('상태 변경 실패:', error);
                showMobileAlert(`[4] 상태 변경에 실패했습니다. (${error.message})`);
                await fetchAndRenderOrders(); // 실패해도 목록은 갱신
            } // finally { startPolling(); }
        }


        // --- 이벤트 리스너 및 초기화 ---

        // 1. 알림 팝업 토글
        notificationTrigger.addEventListener('click', (event) => {
            event.stopPropagation();
            notificationPopup.classList.toggle('show');
        });

        // 2. 팝업 외부 클릭 시 팝업 닫기
        document.addEventListener('click', (event) => {
            if (notificationPopup.classList.contains('show') && !notificationTrigger.contains(event.target)) {
                notificationPopup.classList.remove('show');
            }

            document.querySelectorAll('.card-menu-dropdown.show').forEach(dropdown => {
                if (!dropdown.previousElementSibling.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });

        // 3. 주문 그리드 이벤트 위임
        orderGrid.addEventListener('click', (event) => {
            const target = event.target;

            // (A) 메뉴 버튼 (⋮) 클릭 시
            if (target.classList.contains('card-menu-button')) {
                event.stopPropagation();
                const orderId = target.dataset.orderId; // '⋮' 버튼에서 직접 ID 추출
                const dropdown = document.getElementById(`menu-dropdown-${orderId}`);

                document.querySelectorAll('.card-menu-dropdown.show').forEach(d => {
                    if (d !== dropdown) d.classList.remove('show');
                });
                dropdown.classList.toggle('show');
            }

            // (B) 드롭다운 메뉴 (완료/취소) 클릭 시
            if (target.matches('.card-menu-dropdown button')) {
                event.stopPropagation();
                const dropdown = target.closest('.card-menu-dropdown');

                // ⭐ [수정된 로직] ID를 'card-menu-button'에서 가져옵니다.
                const orderId = dropdown.previousElementSibling.dataset.orderId;
                const status = target.dataset.status;

                // ⭐ [ID 유효성 검사 추가] (Error 1 해결)
                if (!orderId || orderId === 'undefined') {
                    console.error("유효하지 않은 Order ID:", orderId);
                    showMobileAlert('유효하지 않은 주문 ID입니다.');
                    return;
                }

                dropdown.classList.remove('show');

                // 이 시점에서 orderId는 Long 타입의 문자열입니다.
                handleUpdateStatus(orderId, status);
            }
        });

        // 타이머 시작/정지 함수화
        function startPolling() {
            clearInterval(pollingTimer);
            pollingTimer = setInterval(fetchAndRenderOrders, POLLING_INTERVAL);
        }

        // 4. 페이지 로드 시 즉시 주문 목록 가져오기
        fetchAndRenderOrders();

        // 5. (실시간 업데이트) 타이머 시작
        startPolling();

        console.log(`Admin Order Page script loaded. Polling every ${POLLING_INTERVAL / 1000} seconds.`);
    });
</script>

</body>
</html>